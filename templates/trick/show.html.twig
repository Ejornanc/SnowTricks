{% extends "layouts/base.html.twig" %}

{% block title %}{{ trick.name }}{% endblock %}

{% block head %}
    {{ parent() }}
    <style>
        /* Styles CSS pour la liste des articles */
    </style>
{% endblock %}

{% block content %}
    <div class="trick-container">

        {# === Trouver une image pour la bannière === #}
        {% set bannerImage = null %}
        {% for image in trick.images %}
            {% if loop.first %}
                {% set bannerImage = asset('uploads/tricks/images/' ~ image.url) %}
            {% endif %}
        {% endfor %}

        {% if bannerImage is null %}
            {% set bannerImage = asset('Images/no_image_available.png') %}
        {% endif %}

        <div class="trick-banner" style="background-image: url('{{ bannerImage }}')">
            <h1>{{ trick.name }}</h1>
        </div>

        {# === Galerie images + vidéos === #}
        <div class="media-gallery">
            {% set hasImages = trick.images|length > 0 %}
            {% set hasVideos = trick.videos|length > 0 %}

            {# === Affichage des images === #}
            {% if hasImages %}
                {% for image in trick.images %}
                    <div class="media-item">
                        <img src="{{ asset('uploads/tricks/images/' ~ image.url) }}" alt="Image du trick">
                    </div>
                {% endfor %}
            {% else %}
                <div class="media-item">
                    <img src="{{ asset('Images/no_image_available.png') }}" alt="Aucune image disponible">
                </div>
            {% endif %}

            {# === Affichage des vidéos === #}
            {% if hasVideos %}
                {% for video in trick.videos %}
                    <div class="media-item">
                        <iframe src="{{ video.url }}" allowfullscreen></iframe>
                    </div>
                {% endfor %}
            {% else %}
                <div class="media-item">
                    <img src="{{ asset('Images/no_video_available.png') }}" alt="Aucune vidéo disponible">
                </div>
            {% endif %}
        </div>

        {# === Description du trick === #}
        <section class="articles">
            <article>
                <div class="metadata px-4">
                    Écrit le {{ trick.createdAt ? trick.createdAt|date('d/m/Y') ~ ' à ' ~ trick.createdAt|date('H:i') : 'date inconnue' }},
                    {% if trick.updatedAt %}
                        modifié le {{ trick.updatedAt|date('d/m/Y') }} à {{ trick.updatedAt|date('H:i') }}
                    {% else %}
                        jamais modifié
                    {% endif %}
                </div>
                <div class="content px-4">
                    {{ trick.description|raw }}
                </div>
            </article>
        </section>
        {% if app.user %}
        <form method="post" action="{{ path('trick_delete', {slug: trick.slug}) }}" onsubmit="return confirm('Voulez-vous vraiment supprimer ce trick ?');">
        <input type="hidden" name="_token" value="{{ csrf_token('delete_trick_' ~ trick.id) }}">
        <button type="submit" class="btn btn-danger">Supprimer</button>
        </form>

        <form method="get" action="{{ path('unused', {slug: trick.slug}) }}">
        <button type="submit" class="btn btn-primary">Modifier</button>
        </form>
        {% endif %}


        <section class="add-comment">
            <h3>Ajouter un commentaire</h3>

            {% if app.user %}
                {{ form_start(commentForm) }}
                {{ form_row(commentForm.content) }}
                <button type="submit">Envoyer</button>
                {{ form_end(commentForm) }}
            {% else %}
                <p><a href="{{ path('app_login') }}">Connectez-vous</a> pour ajouter un commentaire.</p>
            {% endif %}
        </section>

        <section class="comments">
            <h2>Commentaires</h2>

            {% if trick.comments is not empty %}
                <ul class="comment-list">
                    {% for comment in trick.comments %}
                        <li class="comment">
                            <div class="comment-meta">
                                {# === IMAGE DE PROFIL === #}
                                {% set profileImage = comment.user.image ? asset('uploads/users/' ~ comment.user.image) : asset('Images/Default_User_Image.png') %}
                                <img src="{{ profileImage }}" alt="Avatar de {{ comment.user }}" class="avatar">

                                <strong>{{ comment.user }}</strong> — le {{ comment.createdAt|date('d/m/Y à H:i') }}
                            </div>
                            <div class="comment-content">
                                {{ comment.content|nl2br }}
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>Aucun commentaire pour le moment. Soyez le premier à commenter !</p>
            {% endif %}
        </section>


    </div>
{% endblock %}
